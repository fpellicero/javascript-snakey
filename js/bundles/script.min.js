function Board(a,b,c,d){this.width=a,this.height=b,this.nRows=c,this.nCols=d,this.Gems=[],this.Sprites=this.GenerateBoard()}function Bullet(a,b){this.x=b.x,this.y=b.y,this.width=10,this.height=10,this.Speed=600,this.Direction=a}function Gem(){this.SpawnTime=(new Date).getTime(),this.Duration=this.GetDuration(),this.x=board.GetRandomColOffset(),this.y=board.GetRandomRowOffset(),this.sprite=this.GetRandomSprite(),this.CurrentRotation=0,this.Points=50}function Element(){}function Player(a){"string"!=typeof a&&(a="images/char-horn-girl.png"),this.sprite=a,this.width=100,this.height=101,this.Score=0,this.Health=Config.InitialHealth,this.TopLabel={Value:0,LastUpdate:null},this.Bullets=[],this.LastDirection=DIRECTION.UP}function Enemy(){var a=this.GetInitialDirection(),b=this.GetInitialPosition(a);this.Direction=a,this.x=b.x,this.y=b.y,this.MinSpeed=25,this.speed=this.GetRandomSpeed(),this.LastDirectionChangeTime=(new Date).getTime(),this.dying=!1,this.dieTime=null}function AnimatedEnemy(){Enemy.call(this),this.sprite=this.Sprites[0],this.currentSpriteIndex=0,this.lastFrameTime=(new Date).getTime()}function RedHorn(){AnimatedEnemy.call(this)}function YellowFlam(){AnimatedEnemy.call(this)}function GameOverScreen(){this.EnemySpawner=null,this.GemSpawner=null,this.Activate()}function MainScreen(){this.EnemySpawner=null,this.GemSpawner=null,this.Activate()}function PlayerSelectionScreen(){this.CurrentSelection=Math.floor(this.AvailableChars.length/2),this.SelectorImage="images/Selector.png",this.Events=this.GenerateEvents(),this.Activate()}function Screen(){}function Reset(){player.Spawn()}Board.prototype.GenerateBoard=function(){for(var a=["images/stone-block.png","images/grass-block.png"],b=function(){var b=Math.floor(Math.random()*a.length);return a[b]},c=[],d=0;d<this.nRows;d++)for(var e=0;e<this.nCols;e++)0==e&&(c[d]=[]),c[d].push(b());return c},Board.prototype.GetCellCenterPosition=function(a,b){return{x:a*Config.ColSize,y:b*Config.RowSize+Config.RowSize/2}},Board.prototype.GetRandomRow=function(){return Math.floor(Math.random()*this.nRows)},Board.prototype.GetRowOffset=function(a){return a*Config.RowSize},Board.prototype.GetCenterRowOffset=function(a){return this.GetRowOffset(a)+Config.RowSize/2},Board.prototype.GetRandomRowOffset=function(){return this.GetRowOffset(this.GetRandomRow())},Board.prototype.GetRandomCol=function(){return Math.floor(Math.random()*this.nCols)},Board.prototype.GetColOffset=function(a){return a*Config.ColSize},Board.prototype.GetRandomColOffset=function(){return this.GetColOffset(this.GetRandomCol())},Board.prototype.render=function(a){for(var b=this,c=0;c<this.nRows;c++)for(var d=0;d<this.nCols;d++)ctx.drawImage(Resources.get(b.Sprites[c][d]),b.GetColOffset(d),b.GetRowOffset(c));b.PrintGems()},Board.prototype.PrintGems=function(){for(var a=0;a<this.Gems.length;a++){var b=this.Gems[a],c=!1;b.IsColliding(player)&&(player.Collect(b),c=!0),!c&&b.IsActive()||this.Gems.splice(a,1),b.render()}},Bullet.prototype=Object.create(Element.prototype),Bullet.prototype.constructor=Bullet,Bullet.prototype.update=function(a){var b=this.Speed*a;switch(this.Direction){case DIRECTION.UP:this.y-=b;break;case DIRECTION.DOWN:this.y+=b;break;case DIRECTION.RIGHT:this.x+=b;break;case DIRECTION.LEFT:this.x-=b}},Bullet.prototype.CheckCollisions=function(a){for(var b=this,c=0;c<a.length;c++)if(!a[c].dying&&a[c].IsColliding(b))return a[c].Kill(),!0;return!1},Bullet.prototype.render=function(){ctx.fillRect(this.x,this.y,10,10)};var Config={Margin:0,ColSize:101,RowSize:83,MinGemDuration:1e4,MaxGemDuration:2e4,DiePenalty:100,InitialHealth:3,DieScorePenalty:100,DieHealthPenalty:1,LabelDuration:3e3,TextColor:"#D2312E",TextFont:"2em Verdana",EnemyDyingTime:500},DIRECTION={UP:0,DOWN:1,LEFT:2,RIGHT:3};Gem.prototype=Object.create(Element.prototype),Gem.prototype.constructor=Gem,Gem.prototype.width=60,Gem.prototype.height=60,Gem.prototype.AvailableSprites=["images/Gem Blue.png","images/Gem Green.png","images/Gem Orange.png"],Gem.prototype.GetRandomSprite=function(){var a=Math.floor(Math.random()*this.AvailableSprites.length);return this.AvailableSprites[a]},Gem.prototype.render=function(){var a=this.x+Config.ColSize/2,b=this.y+Config.RowSize;this.PrintWithRotation(Resources.get(this.sprite),a,b,60,60,this.CurrentRotation)},Gem.prototype.update=function(a){this.CurrentRotation+=1*a},Gem.prototype.GetDuration=function(){var a=Math.random()*Config.MaxGemDuration;return Math.max(a,Config.MinGemDuration)},Gem.prototype.IsActive=function(){var a=(new Date).getTime();return a-this.SpawnTime<this.Duration};var Hub={TopOffset:80,PrintScore:function(a){ctx.save(),ctx.fillStyle=Config.TextColor,ctx.font=Config.TextFont,ctx.textAlign="end",ctx.fillText(a+" points",board.width-15,this.TopOffset),ctx.restore()},PrintHealth:function(a){for(var b=Resources.get("images/Heart.png"),c=50,d=5,e=0;e<a;e++)ctx.drawImage(b,d,40,50,85),d+=c}};Element.prototype.render=function(){this.width&&this.height?ctx.drawImage(Resources.get(this.sprite),this.x,this.y,this.width,this.height):ctx.drawImage(Resources.get(this.sprite),this.x,this.y)},Element.prototype.IsInsideScene=function(){return this.x>0&&this.x<board.width&&this.y>0&&this.y<board.height},Element.prototype.IsColliding=function(a){var b=this.GetBoundingBox(),c=a.GetBoundingBox(),d=function(a,b){if(a.x<b.x+b.width&&a.x+a.width>b.x&&a.y<b.y+b.height&&a.height+a.y>b.y)return!0};return d(b,c)},Element.prototype.CanGoLeft=function(){var a=this.GetCurrentSquare();return a.Col>0},Element.prototype.CanGoRight=function(){var a=this.GetCurrentSquare();return a.Col<Config.NumCols-1},Element.prototype.CanGoUp=function(){var a=this.GetCurrentSquare();return a.Row>1},Element.prototype.CanGoDown=function(){var a=this.GetCurrentSquare();return a.Row<Config.NumRows},Element.prototype.GetCenter=function(){return{x:this.x+this.width/2,y:this.y+this.height/2}},Element.prototype.GetBoundingBox=function(){return{x:this.x,y:this.y,width:this.width-10,height:this.height-10}},Element.prototype.GetCurrentSquare=function(){var a=this.GetCenter();return{Row:Math.floor(a.y/Config.RowSize),Col:Math.round(a.x/Config.ColSize)}},Element.prototype.PrintWithRotation=function(a,b,c,d,e,f){ctx.save(),ctx.translate(b,c),ctx.rotate(f),ctx.translate(-d/2,-e/2),ctx.drawImage(a,0,0,d,e),ctx.restore()},Player.prototype=Object.create(Element.prototype),Player.prototype.constructor=Player,Player.prototype.Spawn=function(){var a=Math.floor(board.nCols/2),b=board.nRows-1,c=board.GetCellCenterPosition(a,b);this.x=c.x,this.y=c.y},Player.prototype.goLeft=function(){this.CanGoLeft()&&(this.x-=Config.ColSize)},Player.prototype.goRight=function(){this.CanGoRight()&&(this.x+=Config.ColSize)},Player.prototype.goDown=function(){this.CanGoDown()&&(this.y+=Config.RowSize)},Player.prototype.goUp=function(){this.CanGoUp()&&(this.y-=Config.RowSize)},Player.prototype.handleInput=function(a){if("spacebar"==a)return this.Shoot();switch(this.LastDirection=a,a){case DIRECTION.LEFT:this.goLeft();break;case DIRECTION.RIGHT:this.goRight();break;case DIRECTION.UP:this.goUp();break;case DIRECTION.DOWN:this.goDown()}},Player.prototype.Die=function(){this.Score-=Config.DieScorePenalty,this.Health-=Config.DieHealthPenalty,this.Score=Math.max(this.Score,0),this.Health>0?Reset():(currentScreen.Destroy(),currentScreen=new GameOverScreen)},Player.prototype.Shoot=function(){this.Bullets.push(new Bullet(this.LastDirection,this.GetCenter()))},Player.prototype.Collect=function(a){this.Score+=a.Points,this.TopLabel.Value+=a.Points,this.TopLabel.LastUpdate=(new Date).getTime()},Player.prototype.render=function(){this.Bullets.forEach(function(a){a.render()}),Object.getPrototypeOf(Player.prototype).render.call(this),this.PrintLabel()},Player.prototype.update=function(a){for(var b=0;b<this.Bullets.length;b++){var c=this.Bullets[b];c.IsInsideScene()||this.Bullets.splice(b,1),c.update(a),c.CheckCollisions(allEnemies)&&this.Bullets.splice(b,1)}},Player.prototype.PrintLabel=function(){if(this.TopLabel.Value){var a=(new Date).getTime();if(a-this.TopLabel.LastUpdate>Config.LabelDuration)return void(this.TopLabel.Value=null);var b=this.GetCenter();ctx.save(),ctx.fillStyle=Config.TextColor,ctx.font=Config.TextFont,ctx.strokeText("+"+this.TopLabel.Value,b.x-10,b.y-this.height/2),ctx.restore()}};var player=new Player;!function(){function a(a){a instanceof Array?a.forEach(function(a){b(a)}):b(a)}function b(a){if(f[a])return f[a];var b=new Image;b.onload=function(){f[a]=b,d()&&g.forEach(function(a){a()})},f[a]=!1,b.src=a}function c(a){return f[a]}function d(){var a=!0;for(var b in f)f.hasOwnProperty(b)&&!f[b]&&(a=!1);return a}function e(a){g.push(a)}var f={},g=[];window.Resources={load:a,get:c,onReady:e,isReady:d}}(),Enemy.prototype.sprite="images/enemy-bug.png",Enemy.prototype.width=80,Enemy.prototype.height=80,Enemy.prototype=Object.create(Element.prototype),Enemy.prototype.constructor=Enemy,Enemy.prototype.GetInitialDirection=function(){return Math.round(Math.random()*Object.keys(DIRECTION).length)},Enemy.prototype.GetInitialPosition=function(a){var b={};switch(a){case DIRECTION.UP:b.y=board.height,b.x=board.GetRandomColOffset();break;case DIRECTION.DOWN:b.y=0,b.x=board.GetRandomColOffset();break;case DIRECTION.LEFT:b.y=board.GetRandomRowOffset(),b.x=board.width;break;case DIRECTION.RIGHT:b.y=board.GetRandomRowOffset(),b.x=0}return b},Enemy.prototype.GetRandomSpeed=function(){var a=Math.floor(55*Math.random());return a>this.MinSpeed?a:25},Enemy.prototype.update=function(a){this.UpdatePosition(a),this.CheckPlayerCollision()},Enemy.prototype.UpdatePosition=function(a){switch(this.TryChangeDirection(a),this.Direction){case DIRECTION.UP:this.y-=this.speed*a;break;case DIRECTION.DOWN:this.y+=this.speed*a;break;case DIRECTION.LEFT:this.x-=this.speed*a;break;case DIRECTION.RIGHT:this.x+=this.speed*a}},Enemy.prototype.TryChangeDirection=function(a){var b=(new Date).getTime(),c=b-this.LastDirectionChangeTime;if(!(c<2500||Math.random()<.97)){var d;d=this.Direction==DIRECTION.UP||this.Direction==DIRECTION.DOWN?Math.random()>.5?DIRECTION.RIGHT:DIRECTION.LEFT:Math.random()>.5?DIRECTION.UP:DIRECTION.DOWN,this.Direction=d,this.LastDirectionChangeTime=b}},Enemy.prototype.CheckPlayerCollision=function(){this.IsColliding(player)&&player.Die()},Enemy.prototype.Kill=function(){this.dying=!0,this.dieTime=(new Date).getTime()},Enemy.prototype.IsDead=function(){var a=(new Date).getTime();return this.dying&&a-this.dieTime>Config.EnemyDyingTime};var allEnemies=[];AnimatedEnemy.prototype=Object.create(Enemy.prototype),AnimatedEnemy.prototype.constructor=AnimatedEnemy,AnimatedEnemy.prototype.IsAnimated=function(){return this.Sprites&&this.Sprites.length>1},AnimatedEnemy.prototype.Kill=function(){Object.getPrototypeOf(AnimatedEnemy.prototype).Kill.call(this),this.sprite=this.DamagedSprite},AnimatedEnemy.prototype.update=function(a){if(!this.dying&&(Object.getPrototypeOf(AnimatedEnemy.prototype).update.call(this,a),this.IsAnimated())){var b=(new Date).getTime();b-this.lastFrameTime>this.frameDuration&&(this.lastFrameTime=b,this.currentSpriteIndex=(this.currentSpriteIndex+1)%this.Sprites.length,this.sprite=this.Sprites[this.currentSpriteIndex])}},RedHorn.prototype=Object.create(AnimatedEnemy.prototype),RedHorn.prototype.constructor=RedHorn,RedHorn.prototype.width=65,RedHorn.prototype.height=70,RedHorn.prototype.frameDuration=300,RedHorn.prototype.Sprites=["images/mob/red-horn/frame-1.png","images/mob/red-horn/frame-2.png"],RedHorn.prototype.DamagedSprite="images/mob/red-horn/damaged.png",YellowFlam.prototype=Object.create(AnimatedEnemy.prototype),YellowFlam.prototype.constructor=YellowFlam,YellowFlam.prototype.width=80,YellowFlam.prototype.height=70,YellowFlam.prototype.frameDuration=120,YellowFlam.prototype.DamagedSprite="images/mob/yellow-flam/damaged.png",YellowFlam.prototype.Sprites=["images/mob/yellow-flam/1.png","images/mob/yellow-flam/2.png","images/mob/yellow-flam/3.png","images/mob/yellow-flam/4.png","images/mob/yellow-flam/5.png","images/mob/yellow-flam/6.png","images/mob/yellow-flam/7.png","images/mob/yellow-flam/8.png"],GameOverScreen.prototype=Object.create(Screen.prototype),GameOverScreen.prototype.constructor=GameOverScreen,GameOverScreen.prototype.render=function(){board.render(),this.PrintText()},GameOverScreen.prototype.PrintText=function(){ctx.fillStyle=Config.TextColor,ctx.font="3em Verdana",ctx.textAlign="center",ctx.fillText("GAME OVER",board.width/2,board.height/2-60),ctx.restore()},MainScreen.prototype=Object.create(Screen.prototype),MainScreen.prototype.constructor=MainScreen,MainScreen.prototype.Events=[{element:document,event:"keydown",handler:function(a){var b={32:"spacebar",37:DIRECTION.LEFT,38:DIRECTION.UP,39:DIRECTION.RIGHT,40:DIRECTION.DOWN};player.handleInput(b[a.keyCode])}}],MainScreen.prototype.Activate=function(){this.BindEvents(),this.EnemySpawner=setInterval(function(){var a=Math.random()>.5?new RedHorn:new YellowFlam;allEnemies.push(a)},1500),this.GemSpawner=setInterval(function(){var a=100*Math.random();a>85&&board.Gems.push(new Gem)},1e3),player.Spawn()},MainScreen.prototype.Destroy=function(){this.UnbindEvents(),clearInterval(this.EnemySpawner),clearInterval(this.GemSpawner)},MainScreen.prototype.update=function(a){this._updateEnemies(a),this._updateGems(a),player.update(a)},MainScreen.prototype._updateEnemies=function(a){for(var b=0;b<allEnemies.length;b++){var c=allEnemies[b];c.update(a),c.IsDead()&&allEnemies.splice(b,1)}},MainScreen.prototype._updateGems=function(a){board.Gems.forEach(function(b){b.update(a)})},MainScreen.prototype.render=function(a){board.render(),allEnemies.forEach(function(a){a.render()}),player.render(),Hub.PrintScore(player.Score),Hub.PrintHealth(player.Health)},PlayerSelectionScreen.prototype=Object.create(Screen.prototype),PlayerSelectionScreen.prototype.constructor=PlayerSelectionScreen,PlayerSelectionScreen.prototype.AvailableChars=["images/char-boy.png","images/char-cat-girl.png","images/char-horn-girl.png","images/char-pink-girl.png","images/char-princess-girl.png"],PlayerSelectionScreen.prototype.GenerateEvents=function(){var a=this,b=[];return b.push({element:document,event:"keydown",handler:function(b){var c={37:"left",39:"right",13:"enter"};a.handleInput(c[b.keyCode])}}),b},PlayerSelectionScreen.prototype.handleInput=function(a){switch(a){case"left":this.CurrentSelection=Math.max(0,this.CurrentSelection-1);break;case"right":this.CurrentSelection=Math.min(this.AvailableChars.length-1,this.CurrentSelection+1);break;case"enter":this.SelectCharAndInitGame()}},PlayerSelectionScreen.prototype.SelectCharAndInitGame=function(){player=new Player(this.AvailableChars[this.CurrentSelection]),currentScreen=new MainScreen,this.Destroy()},PlayerSelectionScreen.prototype.render=function(){board.render(),this.PrintText();var a=board.GetRowOffset(board.nRows/2),b=board.GetColOffset(board.nCols/2-this.AvailableChars.length/2);ctx.drawImage(Resources.get(this.SelectorImage),b+this.CurrentSelection*Config.ColSize,a-60);for(var c=0;c<this.AvailableChars.length;c++){var d=this.AvailableChars[c];ctx.drawImage(Resources.get(d),b,a),b+=100}},PlayerSelectionScreen.prototype.PrintText=function(){ctx.fillStyle=Config.TextColor,ctx.font=Config.TextFont,ctx.textAlign="center",ctx.fillText("Choose a character",board.width/2,board.height/2-Config.RowSize),ctx.restore()},Screen.prototype.Activate=function(){this.BindEvents()},Screen.prototype.Destroy=function(){this.UnbindEvents()},Screen.prototype.update=function(){},Screen.prototype.BindEvents=function(){if(this.Events)for(var a=0;a<this.Events.length;a++){var b=this.Events[a];b.element.addEventListener(b.event,b.handler)}},Screen.prototype.UnbindEvents=function(){if(this.Events)for(var a=0;a<this.Events.length;a++){var b=this.Events[a];b.element.removeEventListener(b.event,b.handler)}};var currentScreen=new PlayerSelectionScreen,Engine=function(a){function b(){var a=Date.now(),c=(a-d)/1e3;currentScreen.update(c),currentScreen.render(),d=a,f.requestAnimationFrame(b)}function c(){d=Date.now(),b()}var d,e=a.document,f=a.window,g=e.createElement("canvas"),h=g.getContext("2d");!function(){var b=window.innerWidth-Config.Margin,c=window.innerHeight-Config.Margin;Config.NumCols=Math.floor(b/Config.ColSize),Config.NumRows=Math.floor(c/Config.RowSize)-1,b=Config.NumCols*Config.ColSize,c=Config.NumRows*Config.RowSize+90,g.width=b,g.height=c,a.board=new Board(b,c,Config.NumRows,Config.NumCols),e.body.appendChild(g)}();var i=["images/stone-block.png","images/water-block.png","images/grass-block.png","images/enemy-bug.png","images/char-boy.png","images/Gem Blue.png","images/Gem Green.png","images/Gem Orange.png","images/Heart.png","images/char-boy.png","images/char-cat-girl.png","images/char-horn-girl.png","images/char-pink-girl.png","images/char-princess-girl.png","images/Selector.png"];i.push.apply(i,RedHorn.prototype.Sprites),i.push.apply(i,YellowFlam.prototype.Sprites),i.push(RedHorn.prototype.DamagedSprite),i.push(YellowFlam.prototype.DamagedSprite),Resources.load(i),Resources.onReady(c),a.ctx=h,Reset()}(this);
//# sourceMappingURL=script.min.js.map